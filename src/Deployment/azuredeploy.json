{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "_artifactsLocation": {
      "type": "string",
      "metadata": {
        "description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."
      },
      "defaultValue": ""
    },
    "_artifactsLocationSasToken": {
      "type": "securestring",
      "metadata": {
        "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
      },
      "defaultValue": ""
    },
    "cosmosDbAccountName": {
      "type": "string",
      "minLength": 3,
      "metadata": {
        "description": "The DocumentDB database account name."
      }
    },
    "appInsightsName": {
      "type": "string",
      "defaultValue": "[concat(parameters('webAppName'),'-appinsights')]",
      "metadata": {
        "description": "The name of the appInsights instance"
      }
    },
    "webAppName": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "The name of the Web App"
      }
    },
    "adminWebAppName": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "The name of the Admin Web App"
      }
    },
    "apiAppName": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[concat(parameters('webAppName'), '-api')]",
      "metadata": {
        "description": "The name of the Web App"
      }
    },
    "webAppSKU": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Free",
        "Shared",
        "Basic",
        "Standard"
      ],
      "metadata": {
        "description": "The Web App pricing tier"
      }
    },
    "admninWebAppSKU": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Free",
        "Shared",
        "Basic",
        "Standard"
      ],
      "metadata": {
        "description": "The Admin Web App pricing tier"
      }
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": "[concat(uniqueString(resourceGroup().id),'storage')]",
      "metadata": {
        "description": "The name of the storage acount"
      }
    },
    "storageAccountType": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Standard_ZRS",
        "Standard_GRS",
        "Standard_RAGRS",
        "Premium_LRS"
      ],
      "metadata": {
        "description": "The storage account type"
      }
    },
    "searchName": {
      "type": "string",
      "metadata": {
        "description": "The Azure Search instance name"
      }
    },
    "searchSKU": {
      "type": "string",
      "defaultValue": "standard",
      "allowedValues": [
        "free",
        "standard",
        "standard2",
        "standard3"
      ],
      "metadata": {
        "description": "The azure search instance tier."
      }
    },
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "Name of the vault"
      }
    },
    "configureKeyVault": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Determines whether the default values for the Key Vault secrets should be deployed."
      }
    },
    "vaultSKU": {
      "type": "string",
      "defaultValue": "Standard",
      "allowedValues": [
        "Standard",
        "Premium"
      ],
      "metadata": {
        "description": "SKU for the vault"
      }
    },
    "keyVaultClientId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The Key Vault client identifier."
      }
    },
    "keyVaultClientSecret": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The Key Vault client secret."
      }
    },
    "aadTenant": {
      "type": "string",
      "defaultValue": "xxxxxxxxxxx.onmicrosoft.com",
      "metadata": {
        "description": "The Azure Active Directory B2C tenant (onmicrosoft.com domain)."
      }
    },
    "aadAudience": {
      "type": "string",
      "defaultValue": "00000000-0000-0000-0000-000000000000",
      "metadata": {
        "description": "The Azure Active Directory B2C audience (GUID Tenant ID)."
      }
    },
    "aadB2CScopes0": {
      "type": "string",
      "defaultValue": "user_impersonation",
      "metadata": {
        "description": "The Azure Active Directory B2C required scope."
      }
    },
    "aadPolicy": {
      "type": "string",
      "defaultValue": "B2C_1_Signup",
      "metadata": {
        "description": "The Azure Active Directory B2C sign-in and sign-up policy."
      }
    },
    "aadWebApi": {
      "type": "string",
      "defaultValue": "msrodrapi",
      "metadata": {
        "description": "The Azure Active Directory B2C App ID URI."
      }
    },
    "azfunctionAppName": {
      "type": "string",
      "defaultValue": "msrodr-azfunction",
      "metadata": {
        "description": "The name of the function app that you wish to create."
      }
    },
    "azfunctionStorageAccountType": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Standard_GRS",
        "Standard_RAGRS"
      ],
      "metadata": {
        "description": "Storage Account type"
      }
    },
    "batchAccountName": {
      "type": "string",
      "defaultValue": "msrodrbatch",
      "metadata": {
        "description": "The name of the batch account"
      }
    },
    "batchStorageAccountName": {
      "type": "string",
      "defaultValue": "msrodrbatchstorage",
      "metadata": {
        "description": "The name of the batch storage account"
      }
    },
    "batchStorageSkuName": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Standard_ZRS",
        "Standard_GRS",
        "Standard_RAGRS",
        "Premium_LRS"
      ],
      "metadata": {
        "description": "The batch storage account type"
      }
    }
  },
  "variables": {
    "batchTemplate": "templates/batch.json",
    "cosmosDbTemplate": "templates/cosmosdb.json",
    "keyVaultTemplate": "templates/keyvault.json",
    "storageTemplate": "templates/storage.json",
    "webAppTemplate": "templates/webapp.json",
    "adminWebAppTemplate": "templates/adminwebapp.json",
    "searchTemplate": "templates/search.json",
    "appInsightsTemplate": "templates/appinsights.json",
    "azfunctionTemplate": "templates/azfunction.json"
  },
  "resources": [
    {
      "name": "[parameters('cosmosDbAccountName')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-07-01",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('cosmosDbTemplate'), parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "cosmosDbAccountName": { "value": "[parameters('cosmosDbAccountName')]" }
        }
      }
    },
    {
      "name": "[parameters('appInsightsName')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-07-01",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('appInsightsTemplate'), parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "webAppName": { "value": "[parameters('webAppName')]" },
          "apiAppName": { "value": "[parameters('apiAppName')]" },
          "appInsightsName": { "value": "[parameters('appInsightsName')]" }
        }
      }
    },
    {
      "name": "[parameters('webAppName')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-07-01",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('webAppTemplate'), parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "webAppName": { "value": "[parameters('webAppName')]" },
          "apiAppName": { "value": "[parameters('apiAppName')]" },
          "webAppSKU": { "value": "[parameters('webAppSKU')]" },
          "appInsightsName": { "value": "[parameters('appInsightsName')]" },
          "appInsightsKey": { "value": "[reference(parameters('appInsightsName')).outputs.instrumentationKey.value]" },
          "searchName": { "value": "[parameters('searchName')]" },
          "keyVaultName": { "value": "[parameters('keyVaultName')]" },
          "cosmosDbAccountName": { "value": "[parameters('cosmosDbAccountName')]" },
          "keyVaultClientId": { "value": "[parameters('keyVaultClientId')]" },
          "keyVaultClientSecret": { "value": "[parameters('keyVaultClientSecret')]" },
          "aadTenant": { "value": "[parameters('aadTenant')]" },
          "aadAudience": { "value": "[parameters('aadAudience')]" },
          "aadB2CScopes0": { "value": "[parameters('aadB2CScopes0')]" },
          "aadPolicy": { "value": "[parameters('aadPolicy')]" },
          "aadWebApi": { "value": "[parameters('aadWebApi')]" }
        }
      }
    },
    {
      "name": "[parameters('adminWebAppName')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-07-01",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('adminWebAppTemplate'), parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "webAppName": { "value": "[parameters('webAppName')]" },
          "adminWebAppName": { "value": "[parameters('adminWebAppName')]" },
          "apiAppName": { "value": "[parameters('apiAppName')]" },
          "webAppSKU": { "value": "[parameters('webAppSKU')]" },
          "searchName": { "value": "[parameters('searchName')]" },
          "keyVaultName": { "value": "[parameters('keyVaultName')]" },
          "cosmosDbAccountName": { "value": "[parameters('cosmosDbAccountName')]" },
          "keyVaultClientId": { "value": "[parameters('keyVaultClientId')]" },
          "keyVaultClientSecret": { "value": "[parameters('keyVaultClientSecret')]" },
          "aadTenant": { "value": "[parameters('aadTenant')]" },
          "aadAudience": { "value": "[parameters('aadAudience')]" },
          "aadB2CScopes0": { "value": "[parameters('aadB2CScopes0')]" },
          "aadPolicy": { "value": "[parameters('aadPolicy')]" },
          "aadWebApi": { "value": "[parameters('aadWebApi')]" }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "name": "[parameters('searchName')]",
      "apiVersion": "2016-07-01",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('searchTemplate'), parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "searchName": { "value": "[parameters('searchName')]" },
          "searchSKU": { "value": "[parameters('searchSKU')]" }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "name": "[parameters('storageAccountName')]",
      "apiVersion": "2016-07-01",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('storageTemplate'), parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "storageAccountName": { "value": "[parameters('storageAccountName')]" },
          "storageAccountType": { "value": "[parameters('storageAccountType')]" }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "name": "[parameters('batchAccountName')]",
      "apiVersion": "2016-07-01",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('storageTemplate'), parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "batchAccountName": { "value": "[parameters('batchAccountName')]" },
          "batchStorageSkuName": { "value": "[parameters('batchStorageSkuName')]" }
        }
      }
    },
    {
      "name": "[parameters('azfunctionAppName')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-07-01",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('azfunctionTemplate'), parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "azfunctionAppName": { "value": "[parameters('azfunctionAppName')]" },
          "azfunctionStorageAccountType": { "value": "[parameters('azfunctionStorageAccountType')]" }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "name": "[parameters('keyVaultName')]",
      "apiVersion": "2016-07-01",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('keyVaultTemplate'), parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "vaultSKU": { "value": "[parameters('vaultSKU')]" },
          "keyVaultName": { "value": "[parameters('keyVaultName')]" },
          "storageAccountName": { "value": "[parameters('storageAccountName')]" },
          "appInsightsName": { "value": "[parameters('appInsightsName')]" },
          "searchName": { "value": "[parameters('searchName')]" },
          "cosmosDbAccountName": { "value": "[parameters('cosmosDbAccountName')]" },
          "configureKeyVault": { "value": "[parameters('configureKeyVault')]" }
        }
      }
    }
  ],

  "outputs": {
    "storageAccount": {
      "type": "string",
      "value": "[reference(parameters('storageAccountName')).outputs.accountName.value]"
    },
    "batchStorageAccount": {
      "type": "string",
      "value": "[reference(parameters('batchStorageAccountName')).outputs.accountName.value]"
    },
    "instrumentationKey": {
      "type": "string",
      "value": "reference(parameters('appInsightsName')).outputs.instrumentationKey.value]"
    }
  }
}